<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="reportTotal">

    <select id="getView" resultType="HashMap" parameterType="HashMap">
        select masculine,detection,sampling,crowdName,crowdType from (select lt.masculine,lt.detection,lt.sampling,bc.name crowdName,bct.name crowdType
        from (select crowd_type_id,crowd_id,
           SUM(masculine_total) masculine,
           SUM(detection_total) detection,
           SUM(sampling_total) sampling
        from bs_crowd_total
        where crowd_date = #{crowd_date}
        <trim prefix="AND" prefixOverrides="AND">
            <if test="province_id != null">
                AND province_id = #{province_id}
            </if>
            <if test="city_id != null">
                AND city_id = #{city_id}
            </if>
            <if test="county_id != null">
                AND county_id = #{county_id}
            </if>
        </trim>
        group by crowd_type_id,crowd_id) lt
        left join bs_crowd bc on bc.kid = lt.crowd_id
        left join bs_crowd_type bct on bct.kid = lt.crowd_type_id)t order by crowdType asc
    </select>

    <!--导出Excel报表-->
    <select id="queryDataExport" resultType="HashMap" parameterType="HashMap">
        select crowdName,
            group_concat(crowdType)crowdType,
            group_concat(masculine)masculine,
            group_concat(detection)detection,
            group_concat(sampling)sampling
        from (
        select crowdName,crowdType,masculine,detection,sampling from (select lt.masculine,lt.detection,lt.sampling,bc.name crowdName,bct.name crowdType from (select crowd_type_id,crowd_id,
        SUM(masculine_total) masculine,
        SUM(detection_total) detection,
        SUM(sampling_total) sampling
        from bs_crowd_total
        where crowd_date = #{crowd_date}
        <trim prefix="AND" prefixOverrides="AND">
            <if test="province_id != null">
                AND province_id = #{province_id}
            </if>
            <if test="city_id != null">
                AND city_id = #{city_id}
            </if>
            <if test="county_id != null">
                AND county_id = #{county_id}
            </if>
        </trim>
        group by crowd_type_id,crowd_id) lt
        left join bs_crowd bc on bc.kid = lt.crowd_id
        left join bs_crowd_type bct on bct.kid = lt.crowd_type_id)t order by crowdType ASC) gt group by crowdName
    </select>

    <!-- 从业人员监测结果 -->
    <select id="queryEmployeeReport" resultType="HashMap" parameterType="HashMap">
        select name,GROUP_CONCAT(profession) profession,GROUP_CONCAT(profession_total) profession_total from (
            select sa.name,sd.name profession,lt.profession_total from (
            select city_id,profession,count(profession) profession_total from bs_employee
            <trim prefix="WHERE" prefixOverrides="AND">
                <if test="sampling_date_start != null">
                    <![CDATA[ AND sampling_date >= #{sampling_date_start} ]]>
                </if>
                <if test="sampling_date_end != null">
                    <![CDATA[ AND sampling_date <= #{sampling_date_end} ]]>
                </if>
            </trim>
            group by profession,city_id ORDER BY profession ASC) lt
        left join sys_area sa on sa.kid = lt.city_id
        left join sys_dict sd on sd.KID = lt.profession) gt group by name
    </select>
</mapper>